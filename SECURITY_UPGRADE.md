# 安全升级说明

## 概述
本次升级主要针对登录验证码的安全性问题，将原本硬编码在前端的验证码移至后端进行安全验证。

## 安全问题
**原有问题：**
- 访问代码 `'lay@9527'` 硬编码在前端JavaScript中
- 任何人都可以通过查看页面源代码获取验证码
- 前端验证容易被绕过，存在严重安全风险

## 安全改进

### 1. 后端验证接口
- **新增接口：** `POST /api/auth/verify`
  - 接收访问代码进行后端验证
  - 验证成功后创建安全的认证会话
  - 记录验证尝试日志（包括失败尝试）

### 2. 双重会话机制
- **认证会话（AuthSession）：** 验证访问代码后创建，有效期24小时
- **文件上传会话（Session）：** 基于认证会话创建，用于文件操作，有效期10分钟

### 3. 配置化访问代码
- 访问代码移至 `application.properties` 配置文件
- 配置项：`app.access.code=lay@9527`
- 生产环境可通过环境变量配置

### 4. 前端安全改进
- 移除所有硬编码的验证码
- 使用异步API调用进行验证
- 改进的会话管理和自动过期清理
- 增强的错误处理和用户反馈

### 5. 会话安全
- 自动清理过期会话（认证会话和文件上传会话）
- 客户端信息记录（User-Agent）
- 安全的注销流程，完全清理本地存储

## 技术细节

### 认证流程
1. 用户在首页输入访问代码
2. 前端调用 `/api/auth/verify` 接口验证
3. 后端验证通过后返回 `authSessionId`
4. 前端保存认证会话ID到localStorage
5. 进入上传页面时，使用认证会话ID创建文件上传会话

### 会话管理
```java
// 认证会话超时：24小时
private static final long AUTH_SESSION_TIMEOUT = 24 * 60 * 60 * 1000L;

// 文件上传会话超时：10分钟
private static final long SESSION_TIMEOUT = 10 * 60 * 1000L;
```

### 安全特性
- 服务端验证，不可绕过
- 会话自动过期和清理
- 日志记录和监控
- 客户端状态同步
- 配置化部署

## 部署说明

### 配置访问代码
在 `application.properties` 中修改：
```properties
# 访问代码配置（安全设置）
app.access.code=your_secure_access_code
```

### 生产环境建议
1. 使用强密码作为访问代码
2. 定期更换访问代码
3. 监控登录失败尝试
4. 考虑添加IP白名单限制
5. 启用HTTPS传输加密

## 兼容性
- 向后兼容：自动清理旧的认证标记
- 新用户必须使用新的验证流程
- 现有功能不受影响

## 测试建议
1. 测试正确访问代码的验证流程
2. 测试错误访问代码的拒绝流程
3. 测试会话过期和自动清理
4. 测试注销功能的完整性
5. 验证无法通过前端绕过验证

---
**注意：** 此升级显著提高了系统的安全性，建议在生产环境中立即部署。 